<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Analysis - Filter Ready</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- CSS Reset & Layout --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Sarabun', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* --- Header --- */
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        .header h1 { font-size: 2em; margin-bottom: 5px; font-weight: 700; }
        .header p { font-size: 1em; opacity: 0.9; }

        /* --- Controls --- */
        .controls-container {
            background: white;
            padding: 15px 30px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .input-group { display: flex; align-items: center; gap: 8px; }
        .input-group label { font-weight: 600; color: #555; font-size: 0.9em; }
        .input-group input, .input-group select {
            padding: 8px; border: 1px solid #ddd; border-radius: 6px;
            font-size: 14px; background-color: #f9f9f9; outline: none;
        }
        .control-btn {
            color: white; border: none; padding: 10px 20px; border-radius: 6px;
            cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s ease;
            background: #2c3e50;
            display: flex; align-items: center; gap: 5px;
        }
        .control-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .control-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none;}
        
        .btn-ai { background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); }
        .btn-export { background: #27ae60; }

        /* --- Main Content --- */
        .main-content { padding: 25px; }

        /* --- Overview Section --- */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .overview-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #eee;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
        }
        .overview-card:hover { transform: translateY(-3px); }
        .overview-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; }
        
        .card-revenue::before { background: #e74c3c; }
        .card-total-visit::before { background: #f39c12; }
        .card-unique::before { background: #3498db; }
        .card-paid::before { background: #27ae60; }
        .card-conv::before { background: #9b59b6; }

        .overview-title { font-size: 0.8em; color: #777; font-weight: 600; text-transform: uppercase; margin-bottom: 5px;}
        .overview-value { font-size: 1.8em; font-weight: 800; color: #333; margin: 5px 0; }
        .text-revenue { color: #e74c3c; }
        .overview-sub { font-size: 0.8em; color: #999; }

        /* --- Segmentation Grid --- */
        .section-title { margin: 20px 0 15px 0; font-size: 1.2em; font-weight: 700; color: #333; border-left: 4px solid #3498db; padding-left: 10px; }
        .segment-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .segment-card { background: white; border-radius: 10px; padding: 15px; box-shadow: 0 3px 6px rgba(0,0,0,0.04); border: 1px solid #eee; }
        
        /* Defined Colors for Tiers */
        .tier-0 { border-top: 3px solid #95a5a6; } /* 0-2000: Grey */
        .tier-1 { border-top: 3px solid #bdc3c7; } /* Silver */
        .tier-2 { border-top: 3px solid #2980b9; } /* Blue */
        .tier-3 { border-top: 3px solid #1abc9c; } /* Teal */
        .tier-4 { border-top: 3px solid #f1c40f; } /* Yellow */
        .tier-5 { border-top: 3px solid #e67e22; } /* Orange */
        .tier-6 { border-top: 3px solid #c0392b; } /* Red */

        .seg-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .seg-badge { 
            background: #f0f2f5; color: #333; padding: 4px 8px; border-radius: 6px; 
            font-size: 0.85em; font-weight: 700; border: 1px solid #ddd;
        }
        .seg-stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9em; }

        /* --- Table --- */
        .table-controls {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
        .table-container { background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); overflow: hidden; }
        .table-scroll { max-height: 600px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; vertical-align: top; }
        th { background: #ecf0f1; font-weight: 600; color: #555; position: sticky; top: 0; z-index: 10; }
        tr:hover { background: #f9f9f9; }
        
        .item-list { font-size: 0.85em; color: #555; line-height: 1.5; max-width: 500px; }
        
        .loading { text-align: center; padding: 50px; color: #666; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üìä Sale Segment </h1>
            <p>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>
        </div>
        
        <div class="controls-container">
            <div class="input-group"><label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå:</label><input type="file" id="fileInput" accept=".xlsx, .xls, .csv"></div>
            <div class="input-group"><label>‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà:</label><input type="date" id="startDate" disabled></div>
            <div class="input-group"><label>‡∏ñ‡∏∂‡∏á:</label><input type="date" id="endDate" disabled></div>
            
            <button class="control-btn" id="filterButton" onclick="filterData()" disabled>üîç ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</button>
            <button class="control-btn btn-ai" id="copyButton" onclick="copySummaryAI()" disabled>üìã Copy for Excel</button>
            <button class="control-btn btn-export" onclick="exportData()" id="exportButton" disabled>üì• Export Excel</button>
        </div>

        <div class="main-content">
            <div id="initialMessage" style="text-align: center; padding: 60px; color: #888;">
                <h2>üìÅ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (.xlsx) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</h2>
            </div>
            
            <div id="dashboardView" style="display: none;">
                
                <div class="overview-grid">
                    <div class="overview-card card-revenue">
                        <div class="overview-title">üí∞ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        <div class="overview-value text-revenue" id="valGrandTotal">0</div>
                        <div class="overview-sub">Grand Total Revenue</div>
                    </div>
                    <div class="overview-card card-total-visit">
                        <div class="overview-title">üìå ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>
                        <div class="overview-value" id="valTotalTransactions">0</div>
                        <div class="overview-sub">Total Visits</div>
                    </div>
                    <div class="overview-card card-unique">
                        <div class="overview-title">üë• ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥)</div>
                        <div class="overview-value" id="valTotalUnique">0</div>
                        <div class="overview-sub">Unique Customers</div>
                    </div>
                    <div class="overview-card card-paid">
                        <div class="overview-title">‚úÖ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</div>
                        <div class="overview-value" id="valPaidCustomers">0</div>
                        <div class="overview-sub">Paid Customers</div>
                    </div>
                    <div class="overview-card card-conv">
                        <div class="overview-title">‚ö° % ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</div>
                        <div class="overview-value" id="valConversion">0%</div>
                        <div class="overview-sub">Conversion Rate</div>
                    </div>
                </div>

                <div class="section-title">üì¶ ‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</div>
                <div class="segment-grid" id="segmentContainer"></div>

                <div class="table-controls">
                    <div class="section-title" style="margin:0; border:none; padding:0;">üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ)</div>
                    <div class="input-group">
                        <label>‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°:</label>
                        <select id="segmentSelect" onchange="renderFilteredTable()" style="min-width: 200px; padding: 8px;">
                            <option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 50px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                    <th style="width: 120px;">HN</th>
                                    <th style="width: 250px;">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• & ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th> 
                                    <th style="width: 130px;">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                                    <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</th>
                                    <th style="width: 110px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                                    <th style="width: 110px;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                                </tr>
                            </thead>
                            <tbody id="detailsTableBody"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- Global Variables ---
        let rawData = [], filteredData = [];
        let segmentsData = {}; 
        let globalPaidList = []; // Store full list for filtering

        // --- RANGES CONFIG ---
        const RANGES_CONFIG = [
            { id: 'r0', label: '0 - 2,000', limit: 2000, colorClass: 'tier-0', icon: '‚ö™' },
            { id: 'r1', label: '2,001 - 5,000', limit: 5000, colorClass: 'tier-1', icon: 'üîπ' },
            { id: 'r2', label: '5,001 - 10,000', limit: 10000, colorClass: 'tier-2', icon: 'üîπ' },
            { id: 'r3', label: '10,001 - 20,000', limit: 20000, colorClass: 'tier-3', icon: 'üîπ' },
            { id: 'r4', label: '20,001 - 50,000', limit: 50000, colorClass: 'tier-4', icon: 'üî∂' },
            { id: 'r5', label: '50,001 - 100,000', limit: 100000, colorClass: 'tier-5', icon: 'üî∂' },
            { id: 'r6', label: '100,001 UP', limit: Infinity, colorClass: 'tier-6', icon: 'üëë' }
        ];

        const fileInput = document.getElementById('fileInput'),
              startDateEl = document.getElementById('startDate'),
              endDateEl = document.getElementById('endDate'),
              dashboardView = document.getElementById('dashboardView'),
              initialMessage = document.getElementById('initialMessage'),
              segmentSelect = document.getElementById('segmentSelect');

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            endDateEl.value = toLocalISO(new Date(today.getFullYear(), today.getMonth() + 1, 0));
            startDateEl.value = toLocalISO(new Date(today.getFullYear(), today.getMonth(), 1));
            
            // Init Select Options
            let opts = `<option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</option>`;
            RANGES_CONFIG.forEach(r => {
                opts += `<option value="${r.label}">${r.icon} ${r.label}</option>`;
            });
            segmentSelect.innerHTML = opts;
        });

        fileInput.addEventListener('change', handleFile);
        window.filterData = filterData;
        window.exportData = exportData;
        window.renderFilteredTable = renderFilteredTable;

        // --- Core Functions ---
        
        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            
            initialMessage.innerHTML = `<div class="loading"><div class="spinner"></div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>`;
            
            reader.onload = (event) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(event.target.result), { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: null, cellDates: true, raw: false });
                    
                    if (!jsonData.length) throw new Error("‡πÑ‡∏ü‡∏•‡πå‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤");
                    
                    // Clean Data
                    rawData = jsonData.map(row => {
                        if (!row) return null;
                        let amt = 0;
                        if (row['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞'] !== undefined && row['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞'] !== null) {
                            if (typeof row['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞'] === 'number') amt = row['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞'];
                            else amt = parseFloat(row['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞'].toString().replace(/[,\s]/g, '')) || 0;
                        }
                        
                        let phoneValue = row['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'] || row['‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'] || row['Phone'] || row['Tel'] || row['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'];
                        if (phoneValue !== null && phoneValue !== undefined) row['‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'] = String(phoneValue); 
                        else row['‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'] = '-';
                        
                        return { ...row, '‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞': amt };
                    }).filter(r => r !== null);

                    // Set Date Range
                    let dates = rawData.map(r => parseThaiDate(r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢'])).filter(d => d);
                    if (dates.length) {
                        startDateEl.value = toLocalISO(new Date(Math.min.apply(null, dates)));
                        endDateEl.value = toLocalISO(new Date(Math.max.apply(null, dates)));
                    }

                    [startDateEl, endDateEl, document.getElementById('filterButton'), document.getElementById('exportButton'), document.getElementById('copyButton')]
                        .forEach(el => el.disabled = false);
                    
                    initialMessage.style.display = 'none';
                    dashboardView.style.display = 'block';
                    filterData();

                } catch (err) {
                    alert("Error: " + err.message);
                    initialMessage.innerHTML = `Error: ${err.message}`;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function filterData() {
            const start = new Date(startDateEl.value); start.setHours(0,0,0,0);
            const end = new Date(endDateEl.value); end.setHours(23,59,59,999);
            
            filteredData = rawData.filter(row => {
                const d = parseThaiDate(row['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']);
                return d && d >= start && d <= end;
            });
            
            processAnalysis();
        }

        function processAnalysis() {
            const totalTransactions = filteredData.length;
            const hnMap = {};
            
            filteredData.forEach(row => {
                if (!row.HN) return;
                if (!hnMap[row.HN]) {
                    hnMap[row.HN] = {
                        hn: row.HN,
                        name: row['‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•'] || '-',
                        phone: row['‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'] || '-', 
                        totalAmount: 0,
                        items: new Set(),
                        lastDate: new Date(0)
                    };
                }
                hnMap[row.HN].totalAmount += row['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞'];
                if (row['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']) hnMap[row.HN].items.add(row['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']);
                const d = parseThaiDate(row['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']);
                if (d && d > hnMap[row.HN].lastDate) hnMap[row.HN].lastDate = d;
            });

            const allCustomers = Object.values(hnMap);
            const totalUnique = allCustomers.length;
            const grandTotalRevenue = allCustomers.reduce((sum, c) => sum + c.totalAmount, 0);

            // Filter for list (Include 0)
            const paidCustomersList = allCustomers.filter(c => c.totalAmount >= 0); 
            const paidCount = paidCustomersList.filter(c => c.totalAmount > 0).length; 
            const conversionRate = totalUnique > 0 ? ((paidCount / totalUnique) * 100).toFixed(2) : 0;

            // Buckets Logic
            const rangeBuckets = RANGES_CONFIG.map(r => ({ ...r, count: 0, sum: 0 }));

            paidCustomersList.forEach(c => {
                const amt = c.totalAmount;
                const bucket = rangeBuckets.find(r => amt <= r.limit);
                
                if (bucket) {
                    bucket.count++; 
                    bucket.sum += amt;
                    c.segmentLabel = bucket.label;
                    c.segmentColor = bucket.colorClass;
                } else {
                    c.segmentLabel = 'Unknown';
                    c.segmentColor = '';
                }
            });

            const totalInBuckets = paidCustomersList.length;
            rangeBuckets.forEach(b => {
                b.percent = totalInBuckets > 0 ? ((b.count / totalInBuckets) * 100).toFixed(1) : 0;
            });

            // Update UI
            document.getElementById('valGrandTotal').innerText = grandTotalRevenue.toLocaleString('th-TH', {minimumFractionDigits:2});
            document.getElementById('valTotalTransactions').innerText = totalTransactions.toLocaleString();
            document.getElementById('valTotalUnique').innerText = totalUnique.toLocaleString();
            document.getElementById('valPaidCustomers').innerText = paidCount.toLocaleString();
            document.getElementById('valConversion').innerText = conversionRate + "%";

            renderSegmentCards(rangeBuckets); 
            
            // Store Global List & Render Table
            globalPaidList = paidCustomersList.sort((a,b) => b.totalAmount - a.totalAmount);
            renderFilteredTable();
            
            segmentsData = {
                overview: { grandTotalRevenue, totalTransactions, totalUnique, paidCount, conversionRate },
                buckets: rangeBuckets,
                allList: globalPaidList
            };
        }
        
        function renderSegmentCards(buckets) {
            const container = document.getElementById('segmentContainer');
            container.innerHTML = buckets.map(b => `
                <div class="segment-card ${b.colorClass}">
                    <div class="seg-header">
                        <div style="font-weight:700;">${b.icon} ${b.label}</div>
                        <div class="seg-badge">${b.percent}%</div>
                    </div>
                    <div class="seg-stat-row">
                        <span style="color:#666;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô:</span>
                        <span style="font-weight:bold;">${b.count.toLocaleString()}</span>
                    </div>
                     <div class="seg-stat-row">
                        <span style="color:#666;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span>
                        <span style="font-weight:bold; color:#2980b9;">${b.sum.toLocaleString()}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderFilteredTable() {
            const selectedSegment = segmentSelect.value;
            let displayData = globalPaidList;

            // Apply Filter
            if (selectedSegment !== 'all') {
                displayData = globalPaidList.filter(c => c.segmentLabel === selectedSegment);
            }

            // Apply Sort (Always Descending Amount)
            displayData.sort((a,b) => b.totalAmount - a.totalAmount);

            // Render Table (with Limit 500 for performance)
            const tbody = document.getElementById('detailsTableBody');
            const COLSPAN_COUNT = 7; 
            
            if (!displayData.length) {
                tbody.innerHTML = `<tr><td colspan="${COLSPAN_COUNT}" class="loading">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ</td></tr>`;
                return;
            }

            // Show top 500 of the SELECTED group
            const slicedData = displayData.slice(0, 500);
            
            tbody.innerHTML = slicedData.map((c, i) => `
                <tr>
                    <td>${i+1}</td>
                    <td>${c.hn}</td>
                    <td>
                        <div style="font-weight: 600;">${c.name}</div>
                        <div style="font-size: 0.85em; color: #555;">‡πÇ‡∏ó‡∏£: ${c.phone}</div> 
                    </td>
                    <td>
                        <span style="font-size:0.85em; background:#f4f6f7; padding:4px 8px; border-radius:4px; border:1px solid #ddd; white-space:nowrap; display:inline-block;">
                            ${c.segmentLabel || 'N/A'}
                        </span>
                    </td>
                    <td><div class="item-list">${[...c.items].join(', ')}</div></td>
                    <td>${c.lastDate.toLocaleDateString('th-TH')}</td>
                    <td style="font-weight:bold; color:#2c3e50;">${c.totalAmount.toLocaleString()}</td>
                </tr>
            `).join('');
        }
        
        // --- Copy Function for Excel Paste ---
        function copySummaryAI() {
            if (!segmentsData.overview) return;
            const ov = segmentsData.overview;
            const bk = segmentsData.buckets;

            let text = "";
            text += "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\t‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ\n";
            text += `‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\t${ov.grandTotalRevenue.toLocaleString('en-US', {minimumFractionDigits: 2})}\n`;
            text += `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£\t${ov.totalTransactions.toLocaleString()}\n`;
            text += `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥)\t${ov.totalUnique.toLocaleString()}\n`;
            text += `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (>0)\t${ov.paidCount.toLocaleString()}\n`;
            text += `% ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢\t${ov.conversionRate}%\n\n`;

            text += "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤\t‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô\t‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)\t‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô (%)\n";
            bk.forEach(b => {
                text += `${b.label}\t${b.count.toLocaleString()}\t${b.sum.toLocaleString('en-US', {minimumFractionDigits: 0})}\t${b.percent}%\n`;
            });
            text += `‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô\t${segmentsData.allList.length.toLocaleString()}\t${ov.grandTotalRevenue.toLocaleString('en-US', {minimumFractionDigits: 0})}\t100%`;

            navigator.clipboard.writeText(text).then(() => {
                alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏Å‡∏î Ctrl+V ‡πÉ‡∏ô Excel ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");
            }).catch(err => alert("Copy Error: " + err));
        }

        function exportData() {
            if (!segmentsData.allList || !segmentsData.allList.length) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            const wb = XLSX.utils.book_new();
            
            const summaryData = [
                ['Report Summary', '', '', ''],
                ['Grand Total Revenue', segmentsData.overview.grandTotalRevenue, 'THB', ''],
                ['Total Visits', segmentsData.overview.totalTransactions, 'Times', ''],
                ['Paid Customers (>0)', segmentsData.overview.paidCount, 'Persons', ''],
                [],
                ['Price Segment', 'Customer Count', 'Total Sales', '% of All']
            ];
            segmentsData.buckets.forEach(b => summaryData.push([b.label, b.count, b.sum, b.percent + '%']));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summaryData), "Summary");

            const listData = segmentsData.allList.map((c, i) => ({
                'No': i+1, 'HN': c.hn, 'Name': c.name, 
                'Phone': c.phone, 
                'Segment': c.segmentLabel,
                'Total Amount': c.totalAmount, 'Last Visit': c.lastDate ? c.lastDate.toLocaleDateString('th-TH') : '-',
                'All Items': [...c.items].join(', ') 
            }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(listData), "Customer_List");

            const rawExport = filteredData.map(r => ({
                'Date': r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢'], 'HN': r['HN'], 'Name': r['‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•'],
                'Phone': r['‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'] || '-', 
                'Item': r['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'], 'Amount': r['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞']
            }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rawExport), "Raw_Data");

            XLSX.writeFile(wb, "Sales_Report_Final.xlsx");
        }

        function toLocalISO(d) {
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }
        function parseThaiDate(input) {
            if (input instanceof Date) return input;
            if (typeof input !== 'string') return null;
            const p = input.trim().split('/'); 
            if (p.length !== 3) return null;
            let y = parseInt(p[2]);
            if (y > 2500) y -= 543;
            return new Date(y, parseInt(p[1])-1, parseInt(p[0]));
        }
    </script><script src="/index-7T5KD7DK.js" id="playcode-script"></script>
</body>
</html>
